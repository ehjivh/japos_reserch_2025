# 公開天文台白書2025 回答システム 仕様書

## 1. システム概要

### 1.1 目的
公開天文台白書2025作成のため、全国の公開天文台施設に対して実態調査を実施し、回答を収集・管理するシステムを構築する。

### 1.2 システム構成
- **フロントエンド**: HTML5 + JavaScript (Vanilla JS)
- **バックエンド**: PHP
- **データ形式**: JSON (施設ごとに個別ファイル保存)
- **事前処理**: Python/PHP によるJSON生成

## 2. システム要件

### 2.1 機能要件

#### 2.1.1 認証機能
- 施設IDとパスワードによるログイン
- セッション管理（LocalStorageまたはSessionStorage）
- ログアウト機能

#### 2.1.2 回答入力機能
- question.csvに基づく動的フォーム生成
- 以下の設問タイプに対応：
  - text: テキスト入力
  - radio: 単一選択
  - checkbox: 複数選択
- 前回調査データ(white_paper_2018.csv)の自動入力
- 入力内容のリアルタイムバリデーション
- 必須項目チェック（必須フラグがTRUEの項目）

#### 2.1.3 一時保存機能
- 入力途中のデータを一時保存
- ブラウザのLocalStorageに保存
- 一時保存データからの復元
- 保存日時の表示

#### 2.1.4 送信機能
- 全項目の最終確認画面
- 必須項目の完全性チェック
- PHPバックエンドへのPOST送信
- 送信完了後の確認メッセージ
- 送信履歴の記録

#### 2.1.5 データ保存
- 施設ごとにJSONファイルで保存
- ファイル名形式: `{施設ID}_response.json`
- 保存ディレクトリ: `/data/responses/`
- 送信日時の記録
- バックアップ機能（上書き前のデータ保存）

### 2.2 データ構造

#### 2.2.1 質問データ (question.json)
```json
{
  "questions": [
    {
      "id": "Q001",
      "title": "天文台の施設ID",
      "type": "text",
      "options": null,
      "required": false,
      "order": 1,
      "visible": true,
      "description": "半角で入力してください。"
    },
    {
      "id": "Q021",
      "title": "施設の休館日・定休日（当てはまるものすべて）をお選びください",
      "type": "checkbox",
      "options": ["月曜日", "火曜日", "水曜日", "木曜日", "金曜日", "土曜日", "日曜日", "祝日", "定休日が祝日ならばその次の日", "年末年始", "不定休", "冬季休業"],
      "required": false,
      "order": 21,
      "visible": true,
      "description": ""
    },
    {
      "id": "Q067",
      "title": "オンライン観望会の頻度",
      "type": "radio",
      "options": [],
      "required": false,
      "order": 65,
      "visible": true,
      "description": ""
    },
    {
      "id": "Q088",
      "title": "観望会において、電視観望を導入していますか。",
      "type": "radio",
      "options": ["ほとんど使用している", "時々使用している", "イベント時のみ使用している"],
      "required": false,
      "order": 86,
      "visible": true,
      "description": "現在見えている天体をカメラで撮影（ライブスタックを含む）し、お客様へお見せすることを電視観望とします。"
    }
  ]
}
```

#### 2.2.2 施設データ (members.json)
```json
{
  "members": [
    {
      "facility_id": "01-01",
      "password": "pass",
      "facility_name": "小樽市総合博物館",
      "email": "test@example.com",
      "contact_person": "",
      "last_submit": "2025/09/24 14:17:55"
    }
  ]
}
```

#### 2.2.3 前回回答データ (previous_answers.json)
```json
{
  "01-01": {
    "Q001": "01-01",
    "Q002": "test@example.com",
    "Q005": "小樽市総合博物館",
    ...
  }
}
```

#### 2.2.4 回答データ ({施設ID}_response.json)
```json
{
  "facility_id": "01-01",
  "submit_datetime": "2025-11-28T14:30:00+09:00",
  "last_update": "2025-11-28T14:25:00+09:00",
  "status": "submitted",
  "answers": {
    "Q001": "01-01",
    "Q002": "test@example.com",
    "Q003": "山田太郎",
    ...
  }
}
```

## 3. システム設計

### 3.1 ディレクトリ構成
```
/
├── index.html              # ログイン画面
├── survey.html             # 回答フォーム画面
├── confirm.html            # 確認画面
├── complete.html           # 完了画面
├── admin.html              # 管理者用集計画面
├── css/
│   └── style.css          # スタイルシート
├── js/
│   ├── auth.js            # 認証処理
│   ├── survey.js          # 回答フォーム制御
│   ├── storage.js         # LocalStorage管理
│   ├── validation.js      # バリデーション
│   └── admin.js           # 集計処理
├── php/
│   ├── auth.php           # 認証処理
│   ├── save_draft.php     # 一時保存
│   ├── submit.php         # 送信処理
│   ├── get_data.php       # データ取得
│   └── aggregate.php      # 集計処理
├── data/
│   ├── questions.json     # 設問データ
│   ├── members.json       # 施設データ
│   ├── previous_answers.json  # 前回回答データ
│   └── responses/         # 回答データ保存ディレクトリ
└── scripts/
    ├── csv_to_json.py     # CSV→JSON変換（事前処理）
    └── generate_stats.php # 集計レポート生成
```

### 3.2 画面設計

#### 3.2.1 ログイン画面 (index.html)
- 施設ID入力フィールド
- パスワード入力フィールド
- ログインボタン
- エラーメッセージ表示エリア

#### 3.2.2 回答フォーム画面 (survey.html)
- ヘッダー（施設名、ログアウトボタン）
- 設問表示エリア（動的生成）
- 進捗状況バー
- 一時保存ボタン
- 次へ/戻るボタン
- 確認画面へ進むボタン

#### 3.2.3 確認画面 (confirm.html)
- 全回答内容の一覧表示
- 修正ボタン（フォームに戻る）
- 送信ボタン

#### 3.2.4 完了画面 (complete.html)
- 送信完了メッセージ
- 送信日時の表示
- トップに戻るボタン

#### 3.2.5 管理者用集計画面 (admin.html)
- 回答済み施設一覧
- 未回答施設一覧
- 項目別集計表示
- CSV/Excelエクスポート機能
- グラフ表示（Chart.js利用）

### 3.3 API設計

#### 3.3.1 認証API (php/auth.php)
```
POST /php/auth.php
Request:
{
  "facility_id": "01-01",
  "password": "pass"
}
Response:
{
  "success": true,
  "session_token": "xxx",
  "facility_name": "小樽市総合博物館",
  "has_previous_answer": true
}
```

#### 3.3.2 データ取得API (php/get_data.php)
```
GET /php/get_data.php?type=questions
Response:
{
  "success": true,
  "data": { /* questions.json の内容 */ }
}

GET /php/get_data.php?type=previous&facility_id=01-01
Response:
{
  "success": true,
  "data": { /* 前回回答データ */ }
}
```

#### 3.3.3 一時保存API (php/save_draft.php)
```
POST /php/save_draft.php
Request:
{
  "facility_id": "01-01",
  "answers": { /* 回答データ */ }
}
Response:
{
  "success": true,
  "message": "一時保存しました"
}
```

#### 3.3.4 送信API (php/submit.php)
```
POST /php/submit.php
Request:
{
  "facility_id": "01-01",
  "answers": { /* 回答データ */ }
}
Response:
{
  "success": true,
  "message": "送信が完了しました",
  "submit_datetime": "2025-11-28T14:30:00+09:00"
}
```

## 4. 設問管理機能

### 4.1 設問の追加・削除対応
- question.csvを編集後、csv_to_json.pyで再変換
- visible フラグで表示/非表示を制御（TRUE/FALSE）
- order フィールドで表示順序を管理
- システム側で動的に反映
- 設問の種類：
  - text: テキスト入力
  - radio: 単一選択（ラジオボタン）
  - checkbox: 複数選択（チェックボックス）

### 4.2 設問の表示制御
```javascript
// 表示フラグがtrueの設問のみ表示
questions.filter(q => q.visible).forEach(question => {
  // フォーム生成処理
  // 設問タイプに応じた入力要素を生成
  switch(question.type) {
    case 'text':
      // テキストボックスを生成
      break;
    case 'radio':
      // ラジオボタンを生成
      break;
    case 'checkbox':
      // チェックボックスを生成
      break;
  }
});
```

### 4.3 前回データの適用ロジック
```javascript
function applyPreviousAnswers(previousData, currentQuestions) {
  currentQuestions.forEach(question => {
    if (previousData[question.id]) {
      // 前回データが存在する場合は初期値として設定
      setFormValue(question.id, previousData[question.id]);
    }
  });
}
```

## 5. 集計システム

### 5.1 集計機能
- 回答済み件数のカウント
- 項目別の集計（回答分布）
- 自由記述のリスト化
- 未回答項目の抽出

### 5.2 出力形式
- CSV形式でのエクスポート
- Excel形式でのエクスポート（PHPExcel利用）
- PDF形式でのレポート出力

### 5.3 集計画面の表示項目
```javascript
{
  "total_facilities": 350,
  "submitted": 150,
  "draft": 50,
  "not_started": 150,
  "questions_stats": {
    "Q021": {
      "月曜日": 120,
      "火曜日": 80,
      ...
    }
  }
}
```

## 6. セキュリティ要件

### 6.1 認証
- パスワードのハッシュ化（PHP: password_hash()）
- セッショントークンの発行と検証
- ログイン試行回数の制限

### 6.2 データ保護
- JSONファイルへの直接アクセス制限（.htaccess）
- SQLインジェクション対策（使用する場合）
- XSS対策（入力のサニタイズ）
- CSRF対策（トークン利用）

### 6.3 バックアップ
- 送信前のデータを自動バックアップ
- バックアップディレクトリ: `/data/backups/{YYYYMMDD}/`

## 7. 非機能要件

### 7.1 パフォーマンス
- ページ読み込み時間: 3秒以内
- フォーム保存処理: 1秒以内

### 7.2 ブラウザ対応
- Chrome（最新版）
- Firefox（最新版）
- Safari（最新版）
- Edge（最新版）

### 7.3 レスポンシブデザイン
- PC、タブレット、スマートフォンに対応
- ブレイクポイント: 768px, 1024px

## 8. データ移行・準備

### 8.1 CSV→JSON変換スクリプト (csv_to_json.py)
```python
import csv
import json
from datetime import datetime

def convert_questions_csv():
    """question.csv を questions.json に変換"""
    questions = []
    with open('question.csv', 'r', encoding='utf-8') as f:
        reader = csv.DictReader(f)
        for row in reader:
            # 選択肢の処理：カンマ区切りの文字列を配列に変換
            options_str = row.get('選択肢', '').strip()
            options = options_str.split(',') if options_str else []
            
            questions.append({
                'id': row['設問ID'],
                'title': row['設問タイトル'],
                'type': row['設問タイプ'],
                'options': options,
                'required': row['必須フラグ'] == 'TRUE',
                'order': int(row['表示順']),
                'visible': row['表示フラグ'] == 'TRUE',
                'description': row.get('説明文', '')
            })
    
    with open('data/questions.json', 'w', encoding='utf-8') as f:
        json.dump({'questions': questions}, f, ensure_ascii=False, indent=2)

def convert_members_csv():
    """member.csv を members.json に変換"""
    members = []
    with open('member.csv', 'r', encoding='utf-8') as f:
        reader = csv.DictReader(f)
        for row in reader:
            members.append({
                'facility_id': row['施設ID'],
                'password': row['パスワード'],
                'facility_name': row['施設名'],
                'email': row['メールアドレス'],
                'contact_person': row['担当者名'],
                'last_submit': row['最終送信日時']
            })
    
    with open('data/members.json', 'w', encoding='utf-8') as f:
        json.dump({'members': members}, f, ensure_ascii=False, indent=2)

def convert_previous_answers_csv():
    """white_paper_2018.csv を previous_answers.json に変換"""
    previous_answers = {}
    
    # white_paper_2018.csvの列名と設問IDのマッピングを定義
    # 実際のマッピングは、question.csvの設問と照らし合わせて作成する必要がある
    column_mapping = {
        'メールアドレス': 'Q002',
        '2.ご担当者名': 'Q003',
        '4.電話番号（ハイフンなし・半角数字のみ）': 'Q004',
        '5.施設名（正式名称）': 'Q005',
        '6.施設名（英語名）': 'Q006',
        # 以下、必要に応じて追加
    }
    
    with open('white_paper_2018.csv', 'r', encoding='utf-8') as f:
        reader = csv.DictReader(f)
        for row in reader:
            # 施設IDの取得（CSVに施設IDがない場合は施設名などから特定）
            # member.csvとの突合が必要な場合もある
            facility_id = row.get('（事務用）郵送番号', '')
            
            if facility_id:
                answers = {}
                # 列名マッピングに基づいて設問IDに変換
                for csv_col, question_id in column_mapping.items():
                    if csv_col in row and row[csv_col]:
                        answers[question_id] = row[csv_col]
                
                previous_answers[facility_id] = answers
    
    with open('data/previous_answers.json', 'w', encoding='utf-8') as f:
        json.dump(previous_answers, f, ensure_ascii=False, indent=2)

if __name__ == '__main__':
    convert_questions_csv()
    convert_members_csv()
    convert_previous_answers_csv()
```

## 9. 運用・保守

### 9.1 データバックアップ
- 日次バックアップ（自動実行）
- 週次バックアップ（手動実行）

### 9.2 監視項目
- システムエラーログ
- アクセスログ
- 回答進捗状況

### 9.3 問い合わせ対応
- 管理者用の問い合わせフォーム
- FAQページの作成

## 10. 開発スケジュール（例）

1. **設計フェーズ（1週間）**
   - 詳細設計書作成
   - データベース設計

2. **開発フェーズ（3週間）**
   - Week 1: 認証・フォーム表示機能
   - Week 2: 保存・送信機能
   - Week 3: 集計機能・管理画面

3. **テストフェーズ（1週間）**
   - 単体テスト
   - 結合テスト
   - 負荷テスト

4. **デプロイ・運用（1週間）**
   - 本番環境構築
   - データ移行
   - 運用開始

## 11. 今後の拡張性

### 11.1 考慮事項
- 設問の分岐ロジック（条件付き表示）
- グラフによる可視化機能
- リマインドメール送信機能
- 回答期限管理機能
- モバイルアプリ化
- オンライン観望会などの新しい項目への対応
- 電視観望など新技術に関する設問の追加
- SNS連携（Instagram、YouTube、Xなど）の情報収集

### 11.2 技術的な拡張
- データベース（MySQL/PostgreSQL）への移行
- フレームワークの導入（Laravel, Vue.js等）
- API化（RESTful API）
- 過去データとの比較分析機能
- 経年変化の可視化機能

## 12. 添付資料

### 12.1 サンプルコード
別途、実装サンプルコードを提供

### 12.2 画面モックアップ
別途、画面設計書を作成

---

## 変更履歴

| 版数 | 日付       | 変更内容 | 作成者 |
| ---- | ---------- | -------- | ------ |
| 1.0  | 2025-11-28 | 初版作成 | -      |

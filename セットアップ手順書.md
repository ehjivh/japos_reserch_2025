# 公開天文台白書2025 回答システム セットアップ手順書

## 目次

1. [システム要件](#システム要件)
2. [事前準備](#事前準備)
3. [セットアップ手順](#セットアップ手順)
4. [動作確認](#動作確認)
5. [トラブルシューティング](#トラブルシューティング)
6. [セキュリティ設定](#セキュリティ設定)
7. [バックアップ設定](#バックアップ設定)

---

## システム要件

### サーバー環境

- **OS**: Windows Server 2016以降 または Linux（Ubuntu 20.04以降推奨）
- **Webサーバー**: Apache 2.4以降 または Nginx 1.18以降
- **PHP**: 7.4以降（8.0以降推奨）
- **Python**: 3.6以降（データ変換スクリプト用）
- **ディスク容量**: 最低500MB以上（回答データ保存用）

### クライアント環境

- **ブラウザ**: 
  - Google Chrome（最新版）
  - Mozilla Firefox（最新版）
  - Microsoft Edge（最新版）
  - Safari（最新版）
- **JavaScript**: 有効化必須
- **Cookie/LocalStorage**: 有効化必須

---

## 事前準備

### 1. 必要なファイルの確認

以下のCSVファイルが揃っていることを確認してください：

- `question.csv` - 設問データ（119問）
- `member.csv` - 施設データ（350施設程度）
- `white_paper_2018.csv` - 前回調査データ（任意）

### 2. ソフトウェアのインストール

#### Windowsの場合

1. **XAMPP**（推奨）または**WampServer**のインストール
   - [XAMPP公式サイト](https://www.apachefriends.org/jp/index.html)からダウンロード
   - PHP 7.4以降が含まれるバージョンを選択
   - インストール先: `C:\xampp`（推奨）

2. **Python**のインストール
   - [Python公式サイト](https://www.python.org/downloads/)からダウンロード
   - インストール時に「Add Python to PATH」にチェック

#### Linuxの場合

```bash
# Apache、PHP、Pythonのインストール（Ubuntu/Debian）
sudo apt update
sudo apt install apache2 php php-json php-mbstring python3

# Apache、PHP、Pythonのインストール（CentOS/RHEL）
sudo yum install httpd php php-json php-mbstring python3
```

---

## セットアップ手順

### ステップ1: プロジェクトファイルの配置

#### Windowsの場合（XAMPP使用）

1. プロジェクトフォルダを`C:\xampp\htdocs\`にコピー

```powershell
# PowerShellで実行
Copy-Item -Path "c:\Users\ehjiv\Downloads\japos_reserch_2025" -Destination "C:\xampp\htdocs\japos_reserch_2025" -Recurse
```

#### Linuxの場合

```bash
# プロジェクトフォルダを /var/www/html/ にコピー
sudo cp -r /path/to/japos_reserch_2025 /var/www/html/
sudo chown -R www-data:www-data /var/www/html/japos_reserch_2025
```

### ステップ2: ディレクトリの作成とパーミッション設定

#### Windowsの場合

```powershell
# PowerShellで実行
cd C:\xampp\htdocs\japos_reserch_2025

# 必要なディレクトリを作成
New-Item -ItemType Directory -Path "data\responses" -Force
New-Item -ItemType Directory -Path "data\backups" -Force

# ディレクトリに書き込み権限を付与（IIS_IUSRSまたはEveryone）
icacls "data" /grant "Everyone:(OI)(CI)F" /T
```

#### Linuxの場合

```bash
cd /var/www/html/japos_reserch_2025

# 必要なディレクトリを作成
mkdir -p data/responses
mkdir -p data/backups

# パーミッション設定
chmod 755 data
chmod 755 data/responses
chmod 755 data/backups
chown -R www-data:www-data data
```

### ステップ3: データ変換（CSV → JSON）

1. **scriptsディレクトリに移動**

```powershell
# Windows PowerShell
cd C:\xampp\htdocs\japos_reserch_2025\scripts
```

```bash
# Linux
cd /var/www/html/japos_reserch_2025/scripts
```

2. **変換スクリプトの実行**

```bash
python csv_to_json.py
```

3. **変換結果の確認**

以下のメッセージが表示されることを確認：

```
=== CSV to JSON Converter ===
Started at: 2025-11-28 XX:XX:XX

Converting question.csv to questions.json...
✓ Successfully converted 117 questions

Converting member.csv to members.json...
✓ Successfully converted 328 members

Converting white_paper_2018.csv to previous_answers.json...
✓ Successfully converted XXX previous answers

=== Conversion completed ===
```

4. **生成されたJSONファイルの確認**

```powershell
# Windows
dir ..\data\*.json
```

```bash
# Linux
ls -lh ../data/*.json
```

以下のファイルが存在することを確認：
- `data/questions.json`
- `data/members.json`
- `data/previous_answers.json`

### ステップ4: Webサーバーの設定

#### Windowsの場合（XAMPP）

1. **XAMPPコントロールパネルを起動**

2. **Apacheを起動**
   - 「Apache」の「Start」ボタンをクリック
   - ステータスが緑色になることを確認

3. **php.iniの設定確認**（必要に応じて）
   - XAMPPコントロールパネルで「Apache」→「Config」→「PHP (php.ini)」
   - 以下の設定を確認：

```ini
; 最大アップロードサイズ
upload_max_filesize = 20M
post_max_size = 20M

; タイムゾーン
date.timezone = Asia/Tokyo

; エラー表示（開発時のみ）
display_errors = On
error_reporting = E_ALL
```

#### Linuxの場合

1. **Apacheの設定**

```bash
# Virtual Hostの設定（任意）
sudo nano /etc/apache2/sites-available/japos.conf
```

```apache
<VirtualHost *:80>
    ServerName japos.example.com
    DocumentRoot /var/www/html/japos_reserch_2025
    
    <Directory /var/www/html/japos_reserch_2025>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    
    ErrorLog ${APACHE_LOG_DIR}/japos_error.log
    CustomLog ${APACHE_LOG_DIR}/japos_access.log combined
</VirtualHost>
```

2. **サイトの有効化とApacheの再起動**

```bash
sudo a2ensite japos.conf
sudo a2enmod rewrite
sudo systemctl restart apache2
```

3. **php.iniの設定**

```bash
sudo nano /etc/php/8.0/apache2/php.ini
```

```ini
date.timezone = Asia/Tokyo
upload_max_filesize = 20M
post_max_size = 20M
```

```bash
sudo systemctl restart apache2
```

### ステップ5: .htaccessの確認

`data/.htaccess`ファイルが存在することを確認：

```apache
Order Deny,Allow
Deny from all
```

このファイルにより、dataディレクトリへの直接アクセスが制限されます。

---

## 動作確認

### 1. システムへのアクセス

ブラウザで以下のURLにアクセス：

- **Windows（XAMPP）**: `http://localhost/japos_reserch_2025/`
- **Linux（ローカル）**: `http://localhost/japos_reserch_2025/`
- **本番環境**: `http://your-domain.com/`

### 2. ログイン画面の確認

1. ログイン画面が表示されることを確認
2. テスト用の施設IDとパスワードでログイン

**member.csvから任意の施設IDとパスワードを使用**

例：
- 施設ID: `01-01`
- パスワード: member.csvに記載のパスワード

### 3. 回答フォームの確認

1. ログイン後、回答フォーム画面に遷移することを確認
2. 設問が正しく表示されることを確認
3. 前回データが自動入力されることを確認（該当施設の場合）

### 4. 一時保存機能の確認

1. 任意の設問に回答を入力
2. 「一時保存」ボタンをクリック
3. 「保存しました」のメッセージが表示されることを確認
4. ログアウト後、再度ログインして入力内容が復元されることを確認

### 5. 送信機能の確認

1. 必須項目を入力
2. 「確認画面へ」ボタンをクリック
3. 確認画面で入力内容を確認
4. 「送信する」ボタンをクリック
5. 完了画面が表示されることを確認
6. `data/responses/`に回答ファイルが保存されることを確認

```powershell
# Windows
dir data\responses\
```

```bash
# Linux
ls -lh data/responses/
```

### 6. 管理画面の確認

1. `admin.html`にアクセス
2. 回答状況の統計が表示されることを確認
3. 施設一覧が表示されることを確認
4. 設問別集計が表示されることを確認

---

## トラブルシューティング

### 問題1: ログイン画面が表示されない

**原因**: Webサーバーが起動していない、またはパスが間違っている

**対処法**:
1. Webサーバーの起動を確認
   - Windows: XAMPPコントロールパネルでApacheが緑色か確認
   - Linux: `sudo systemctl status apache2`
2. URLが正しいか確認
3. ブラウザのキャッシュをクリア（Ctrl+Shift+Delete）

### 問題2: ログインできない

**原因**: JSONファイルが正しく生成されていない、またはパスワードが間違っている

**対処法**:
1. `data/members.json`が存在するか確認
2. JSONファイルの内容を確認
   ```powershell
   # Windows
   Get-Content data\members.json | Select-Object -First 20
   ```
   ```bash
   # Linux
   head -n 20 data/members.json
   ```
3. member.csvのパスワードと照合

### 問題3: 設問が表示されない

**原因**: questions.jsonが正しく読み込まれていない

**対処法**:
1. `data/questions.json`が存在するか確認
2. ブラウザの開発者ツール（F12）でエラーを確認
3. PHPエラーログを確認
   - Windows XAMPP: `C:\xampp\apache\logs\error.log`
   - Linux: `/var/log/apache2/error.log`

### 問題4: データが保存されない

**原因**: ディレクトリの書き込み権限がない

**対処法**:
1. ディレクトリのパーミッションを確認
   ```powershell
   # Windows
   icacls data\responses
   ```
   ```bash
   # Linux
   ls -ld data/responses/
   ```
2. 書き込み権限を付与
   ```powershell
   # Windows
   icacls "data\responses" /grant "Everyone:(OI)(CI)F" /T
   ```
   ```bash
   # Linux
   sudo chmod 755 data/responses
   sudo chown www-data:www-data data/responses
   ```

### 問題5: JSONファイルが生成されない（CSV変換時）

**原因**: CSVファイルのパスが間違っている、またはエンコーディングの問題

**対処法**:
1. CSVファイルがプロジェクトルートに存在するか確認
   - `question.csv`
   - `member.csv`
   - `white_paper_2018.csv`
2. scriptsディレクトリから実行しているか確認
3. Pythonのエラーメッセージを確認
4. CSVファイルのエンコーディングを確認（UTF-8、Shift-JIS、CP932に対応）

### 問題6: 管理画面にデータが表示されない

**原因**: 回答データが存在しない、またはPHPのJSONエンコーディングエラー

**対処法**:
1. `data/responses/`に回答ファイルが存在するか確認
2. ブラウザの開発者ツールでネットワークタブを確認
3. `php/aggregate.php`が正しく実行されているか確認

---

## セキュリティ設定

### 1. パスワードのハッシュ化（本番環境必須）

現在のシステムは平文でパスワードを保存しています。本番環境では必ずハッシュ化してください。

#### member.csvのパスワードをハッシュ化

```php
<?php
// scripts/hash_passwords.php（新規作成）
$membersJson = file_get_contents('../data/members.json');
$membersData = json_decode($membersJson, true);

foreach ($membersData['members'] as &$member) {
    // パスワードをハッシュ化
    $member['password'] = password_hash($member['password'], PASSWORD_DEFAULT);
}

file_put_contents('../data/members.json', json_encode($membersData, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
echo "Passwords hashed successfully!\n";
?>
```

#### php/auth.phpの修正

```php
// パスワード確認部分を修正
if (!password_verify($password, $facility['password'])) {
    echo json_encode([
        'success' => false,
        'message' => 'パスワードが正しくありません。'
    ], JSON_UNESCAPED_UNICODE);
    exit;
}
```

### 2. HTTPS化（本番環境必須）

Let's Encryptを使用した無料SSL証明書の設定：

```bash
# Linuxの場合
sudo apt install certbot python3-certbot-apache
sudo certbot --apache -d your-domain.com
```

### 3. CSRFトークンの実装

フォームにCSRFトークンを追加することを推奨。

### 4. XSS対策

入力値のサニタイズ処理を追加：

```php
function sanitize_input($data) {
    return htmlspecialchars($data, ENT_QUOTES, 'UTF-8');
}
```

### 5. セッション管理の強化

```php
// セッションの有効期限設定
ini_set('session.gc_maxlifetime', 3600); // 1時間
session_start();
```

---

## バックアップ設定

### 1. 手動バックアップ

```powershell
# Windows PowerShell
$date = Get-Date -Format "yyyyMMdd_HHmmss"
Copy-Item -Path "data" -Destination "backups\data_$date" -Recurse
```

```bash
# Linux
date=$(date +%Y%m%d_%H%M%S)
tar -czf backups/data_$date.tar.gz data/
```

### 2. 自動バックアップ（日次）

#### Windowsの場合（タスクスケジューラ）

1. `scripts/backup.ps1`を作成：

```powershell
$date = Get-Date -Format "yyyyMMdd"
$backupDir = "C:\xampp\htdocs\japos_reserch_2025\backups\$date"
New-Item -ItemType Directory -Path $backupDir -Force
Copy-Item -Path "C:\xampp\htdocs\japos_reserch_2025\data\*" -Destination $backupDir -Recurse
```

2. タスクスケジューラで毎日実行するように設定

#### Linuxの場合（cron）

```bash
# crontabに追加
crontab -e

# 毎日午前3時に実行
0 3 * * * /usr/bin/tar -czf /var/www/html/japos_reserch_2025/backups/data_$(date +\%Y\%m\%d).tar.gz /var/www/html/japos_reserch_2025/data/
```

### 3. バックアップの保持期間

古いバックアップを自動削除（30日以上前のファイル）：

```powershell
# Windows PowerShell
Get-ChildItem "backups" -Recurse | Where-Object {$_.LastWriteTime -lt (Get-Date).AddDays(-30)} | Remove-Item -Recurse
```

```bash
# Linux
find /var/www/html/japos_reserch_2025/backups -type f -mtime +30 -delete
```

---

## 付録

### A. システムファイル一覧

```
japos_reserch_2025/
├── index.html              # ログイン画面
├── survey.html             # 回答フォーム
├── confirm.html            # 確認画面
├── complete.html           # 完了画面
├── admin.html              # 管理画面
├── README.md              # システム概要
├── セットアップ手順書.md    # 本ドキュメント
├── システム仕様書.md        # システム仕様書
├── css/
│   └── style.css          # スタイルシート
├── js/
│   ├── auth.js            # 認証処理
│   ├── storage.js         # ストレージ管理
│   ├── validation.js      # バリデーション
│   ├── survey.js          # フォーム制御
│   └── admin.js           # 管理画面処理
├── php/
│   ├── auth.php           # 認証API
│   ├── get_data.php       # データ取得API
│   ├── save_draft.php     # 一時保存API
│   ├── submit.php         # 送信API
│   └── aggregate.php      # 集計API
├── data/
│   ├── .htaccess          # アクセス制限
│   ├── questions.json     # 設問データ
│   ├── members.json       # 施設データ
│   ├── previous_answers.json  # 前回回答データ
│   ├── responses/         # 回答保存ディレクトリ
│   └── backups/           # バックアップディレクトリ
└── scripts/
    └── csv_to_json.py     # CSV→JSON変換スクリプト
```

### B. よく使うコマンド

```bash
# データ変換
cd scripts && python csv_to_json.py

# Webサーバー再起動（Linux）
sudo systemctl restart apache2

# ログ確認（Linux）
tail -f /var/log/apache2/error.log

# パーミッション確認（Linux）
ls -lR data/

# ディスク使用量確認
du -sh data/
```

### C. サポート情報

- **システム管理者**: [連絡先を記載]
- **技術サポート**: [連絡先を記載]
- **緊急連絡先**: [連絡先を記載]

---

## 改訂履歴

| 版数 | 日付       | 改訂内容 | 作成者 |
| ---- | ---------- | -------- | ------ |
| 1.0  | 2025-11-28 | 初版作成 | -      |

---

**以上でセットアップは完了です。不明な点がありましたら、システム管理者にお問い合わせください。**

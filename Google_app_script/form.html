<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—¥æœ¬å…¬é–‹å¤©æ–‡å°å”ä¼š 2025å¹´å…¬é–‹å¤©æ–‡å°èª¿æŸ»</title>
  <style>
    body {
      font-family: 'Hiragino Sans', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ã‚·ãƒƒã‚¯', 'Yu Gothic', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      line-height: 1.6;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1,
    h2,
    h3 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 5px;
    }

    .section {
      margin-bottom: 30px;
    }

    .hidden {
      display: none;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      color: #555;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    textarea,
    select {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus,
    textarea:focus {
      border-color: #4CAF50;
      outline: none;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .radio-group,
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 10px;
    }

    .radio-group label,
    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: normal;
      margin-bottom: 0;
      cursor: pointer;
      padding: 5px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
      transition: background-color 0.3s;
    }

    .radio-group label:hover,
    .checkbox-group label:hover {
      background-color: #e9f5e9;
    }

    .radio-group input[type="radio"],
    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    button {
      background-color: #4CAF50;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
      margin-bottom: 10px;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #45a049;
    }

    button.secondary {
      background-color: #757575;
    }

    button.secondary:hover {
      background-color: #616161;
    }

    .error {
      color: #f44336;
      font-size: 14px;
      margin-top: 5px;
    }

    .success {
      color: #4CAF50;
      font-size: 16px;
      text-align: center;
      padding: 20px;
      background-color: #e8f5e8;
      border-radius: 4px;
    }

    .user-info {
      background-color: #e3f2fd;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .question {
      background-color: #fafafa;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      border-left: 4px solid #4CAF50;
    }

    .question-title {
      font-weight: bold;
      margin-bottom: 10px;
    }

    .question-description {
      color: #666;
      font-size: 14px;
      margin-bottom: 15px;
      line-height: 1.5;
      background-color: #f0f7ff;
      padding: 10px;
      border-radius: 4px;
      border-left: 3px solid #2196F3;
    }

    .other-input {
      width: 100%;
      margin-top: 10px;
      padding: 8px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
      display: none;
    }

    .other-input:focus {
      border-color: #4CAF50;
      outline: none;
    }

    .required {
      color: #f44336;
      font-size: 12px;
    }

    .confirm-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .confirm-table th,
    .confirm-table td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: left;
    }

    .confirm-table th {
      background-color: #f5f5f5;
      font-weight: bold;
      width: 30%;
    }

    @media (max-width: 600px) {
      .container {
        padding: 15px;
      }

      .radio-group,
      .checkbox-group {
        flex-direction: column;
      }

      button {
        width: 100%;
        margin-right: 0;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>æ—¥æœ¬å…¬é–‹å¤©æ–‡å°å”ä¼š 2025å¹´å…¬é–‹å¤©æ–‡å°èª¿æŸ»</h1>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="login-section" class="section">
      <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <div class="form-group">
        <label for="memberID">ä¼šå“¡ç•ªå· <span class="required">*</span></label>
        <input type="text" id="memberID" required>
      </div>
      <div class="form-group">
        <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <span class="required">*</span></label>
        <input type="password" id="password" required>
      </div>
      <button onclick="checkCredentials()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div id="login-error" class="error"></div>
    </div>

    <!-- ä¼šå“¡æƒ…å ±ç·¨é›†ç”»é¢ -->
    <div id="member-section" class="section hidden">
      <h2>å›ç­”è€…ã®æƒ…å ±</h2>
      <div class="user-info">
        <p><strong>ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š</strong><span id="display-name"></span> ã•ã‚“</p>
      </div>

      <div class="form-group">
        <label for="name">æ°å <span class="required">*</span></label>
        <input type="text" id="name" required>
      </div>

      <div class="form-group">
        <label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span class="required">*</span></label>
        <input type="email" id="email" required>
      </div>

      <div class="form-group">
        <label for="organization">æ‰€å±</label>
        <input type="text" id="organization">
      </div>

      <button onclick="proceedToSurvey()">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«é€²ã‚€</button>
    </div>

    <!-- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç”»é¢ -->
    <div id="survey-section" class="section hidden">
      <h2>ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h2>
      <div id="questions-container"></div>
      <button onclick="showConfirm()">ç¢ºèªç”»é¢ã¸</button>
      <button onclick="savePartialAnswers()" class="secondary">éƒ¨åˆ†ä¿å­˜</button>
      <button class="secondary" onclick="backToMember()">ä¼šå“¡æƒ…å ±ã«æˆ»ã‚‹</button>
      <div id="survey-error" class="error"></div>
      <div id="survey-success" class="success" style="display: none;"></div>
    </div>

    <!-- ç¢ºèªç”»é¢ -->
    <div id="confirm-section" class="section hidden">
      <h2>å›ç­”å†…å®¹ç¢ºèª</h2>

      <h3>ä¼šå“¡æƒ…å ±</h3>
      <table class="confirm-table">
        <tr>
          <th>æ°å</th>
          <td id="confirm-name"></td>
        </tr>
        <tr>
          <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
          <td id="confirm-email"></td>
        </tr>
        <tr>
          <th>æ‰€å±</th>
          <td id="confirm-organization"></td>
        </tr>
        <tr>
          <th>æ€§åˆ¥</th>
          <td id="confirm-gender"></td>
        </tr>
      </table>

      <h3>ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”</h3>
      <div id="confirm-answers"></div>

      <div style="margin-top: 30px;">
        <button onclick="submitAll()">ã“ã®å†…å®¹ã§é€ä¿¡</button>
        <button class="secondary" onclick="backToSurvey()">ä¿®æ­£ã™ã‚‹</button>
      </div>
    </div>

    <!-- å®Œäº†ç”»é¢ -->
    <div id="complete-section" class="section hidden">
      <div class="success">
        <h2>é€ä¿¡å®Œäº†</h2>
        <p>ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®å›ç­”ãŒæ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚<br>ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚</p>
        <button onclick="startOver()">æ–°ã—ãå›ç­”ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
    let cachedMemberID = "";
    let questionsData = [];
    let currentAnswers = {};

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    function checkCredentials() {
      const memberID = document.getElementById('memberID').value;
      const password = document.getElementById('password').value;

      if (!memberID || !password) {
        showError('login-error', 'ä¼šå“¡ç•ªå·ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      cachedMemberID = memberID;

      google.script.run
        .withSuccessHandler(function (response) {
          if (response.success) {
            // ä¼šå“¡æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('display-name').textContent = response.name;
            document.getElementById('name').value = response.name || '';
            document.getElementById('email').value = response.email || '';
            document.getElementById('organization').value = response.organization || '';

            // æ€§åˆ¥ã®åˆæœŸå€¤ã‚’è¨­å®š
            if (response.gender) {
              const radios = document.getElementsByName('gender');
              for (let radio of radios) {
                if (radio.value === response.gender) {
                  radio.checked = true;
                }
              }
            }

            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            hideAllSections();
            document.getElementById('member-section').classList.remove('hidden');
            clearError('login-error');
          } else {
            showError('login-error', response.message || 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(function (error) {
          showError('login-error', 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
          console.error(error);
        })
        .getUserData(memberID, password);
    }

    // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç”»é¢ã«é€²ã‚€
    function proceedToSurvey() {
      // è¨­å•ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç”»é¢ã‚’è¡¨ç¤º
      google.script.run
        .withSuccessHandler(function (response) {
          if (response.success) {
            questionsData = response.questions;
            renderQuestions();
            loadExistingAnswers();
            hideAllSections();
            document.getElementById('survey-section').classList.remove('hidden');
          } else {
            showError('survey-error', response.message || 'è¨­å•ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(function (error) {
          showError('survey-error', 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
          console.error(error);
        })
        .getQuestionData();
    }

    // æ—¢å­˜ã®å›ç­”ã‚’èª­ã¿è¾¼ã¿
    function loadExistingAnswers() {
      google.script.run
        .withSuccessHandler(function (response) {
          if (response.success) {
            currentAnswers = response.answers;

            // æ—¢å­˜å›ç­”ãŒã‚ã‚‹å ´åˆã®é€šçŸ¥è¡¨ç¤º
            if (response.hasExistingData) {
              showExistingDataNotification();
            }

            // ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¢å­˜ã®å›ç­”ã‚’åæ˜ 
            Object.keys(currentAnswers).forEach(questionId => {
              setAnswerToForm(questionId, currentAnswers[questionId]);
            });
          }
        })
        .withFailureHandler(function (error) {
          console.error('æ—¢å­˜å›ç­”ã®å–å¾—ã«å¤±æ•—:', error);
        })
        .getExistingAnswers(cachedMemberID);
    }

    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®é€šçŸ¥ã‚’è¡¨ç¤º
    function showExistingDataNotification() {
      const container = document.getElementById('questions-container');
      const notification = document.createElement('div');
      notification.className = 'existing-data-notification';
      notification.innerHTML = `
        <div style="background-color: #e3f2fd; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
          <strong>ğŸ“‹ æ—¢å­˜ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</strong><br>
          å‰å›ã®å›ç­”å†…å®¹ãŒè‡ªå‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚<br>
          å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
        </div>
      `;
      container.insertBefore(notification, container.firstChild);
    }

    // è¨­å•ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderQuestions() {
      const container = document.getElementById('questions-container');
      container.innerHTML = '';

      questionsData.forEach(question => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question';
        questionDiv.innerHTML = createQuestionHTML(question);
        container.appendChild(questionDiv);
      });

      // æ—¢å­˜å›ç­”ãŒã‚ã‚‹å ´åˆã¯é€šçŸ¥ã‚’å…ˆé ­ã«è¿½åŠ 
      if (Object.keys(currentAnswers).length > 0) {
        showExistingDataNotification();
      }
    }

    // è¨­å•HTMLã‚’ç”Ÿæˆ
    function createQuestionHTML(question) {
      let html = `<div class="question-title">
          ${question.title}
          ${question.required ? '<span class="required">*</span>' : ''}
        </div>`;

      // èª¬æ˜æ–‡ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
      if (question.description && question.description.trim() !== '') {
        html += `<div class="question-description">${question.description}</div>`;
      }

      switch (question.type) {
        case 'radio':
          html += `<div class="radio-group">`;
          question.options.forEach(option => {
            html += `<label>
                <input type="radio" name="q_${question.id}" value="${option}" 
                       ${question.required ? 'required' : ''}
                       onchange="handleRadioChange('${question.id}', '${option}')">
                ${option}
              </label>`;
          });
          html += `</div>`;

          // ã€Œãã®ä»–ã€ã®è‡ªç”±è¨˜è¿°æ¬„ã‚’è¿½åŠ 
          if (question.options.some(opt => opt.includes('ãã®ä»–'))) {
            html += `<input type="text" class="other-input" id="other_${question.id}" 
                     placeholder="ãã®ä»–ã®å ´åˆã¯å…·ä½“çš„ã«ã”è¨˜å…¥ãã ã•ã„..." 
                     onchange="handleOtherInput('${question.id}')">`;
          }
          break;

        case 'checkbox':
          html += `<div class="checkbox-group">`;
          question.options.forEach(option => {
            html += `<label>
                <input type="checkbox" name="q_${question.id}" value="${option}"
                       onchange="handleCheckboxChange('${question.id}', '${option}')">
                ${option}
              </label>`;
          });
          html += `</div>`;

          // ã€Œãã®ä»–ã€ã®è‡ªç”±è¨˜è¿°æ¬„ã‚’è¿½åŠ 
          if (question.options.some(opt => opt.includes('ãã®ä»–'))) {
            html += `<input type="text" class="other-input" id="other_${question.id}" 
                     placeholder="ãã®ä»–ã®å ´åˆã¯å…·ä½“çš„ã«ã”è¨˜å…¥ãã ã•ã„..." 
                     onchange="handleOtherInput('${question.id}')">`;
          }
          break;

        case 'text':
          html += `<textarea name="q_${question.id}" placeholder="ã“ã¡ã‚‰ã«ã”è¨˜å…¥ãã ã•ã„..." 
                     ${question.required ? 'required' : ''}></textarea>`;
          break;
      }

      return html;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¢å­˜ã®å›ç­”ã‚’è¨­å®š
    function setAnswerToForm(questionId, answer) {
      const question = questionsData.find(q => q.id === questionId);
      if (!question) return;

      const elements = document.getElementsByName(`q_${questionId}`);

      if (question.type === 'radio') {
        elements.forEach(el => {
          if (el.value === answer) {
            el.checked = true;
            // ã€Œãã®ä»–ã€ã®å ´åˆã¯å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
            if (answer.includes('ãã®ä»–') && answer !== 'ãã®ä»–') {
              const otherInput = document.getElementById(`other_${questionId}`);
              if (otherInput) {
                otherInput.style.display = 'block';
                otherInput.value = answer.replace('ãã®ä»–:', '').trim();
              }
            }
          }
        });
      } else if (question.type === 'checkbox') {
        const answers = answer.split(',').map(a => a.trim());
        elements.forEach(el => {
          if (answers.some(ans => ans === el.value || (ans.includes('ãã®ä»–') && el.value.includes('ãã®ä»–')))) {
            el.checked = true;
          }
        });

        // ã€Œãã®ä»–ã€ã®å›ç­”ãŒã‚ã‚‹å ´åˆã¯å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
        const otherAnswer = answers.find(ans => ans.includes('ãã®ä»–') && ans !== 'ãã®ä»–');
        if (otherAnswer) {
          const otherInput = document.getElementById(`other_${questionId}`);
          if (otherInput) {
            otherInput.style.display = 'block';
            otherInput.value = otherAnswer.replace('ãã®ä»–:', '').trim();
          }
        }
      } else if (question.type === 'text') {
        if (elements[0]) {
          elements[0].value = answer;
        }
      }
    }

    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å¤‰æ›´å‡¦ç†
    function handleRadioChange(questionId, selectedValue) {
      const otherInput = document.getElementById(`other_${questionId}`);
      if (otherInput) {
        if (selectedValue.includes('ãã®ä»–')) {
          otherInput.style.display = 'block';
          otherInput.focus();
        } else {
          otherInput.style.display = 'none';
          otherInput.value = '';
        }
      }
    }

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´å‡¦ç†
    function handleCheckboxChange(questionId, selectedValue) {
      const otherInput = document.getElementById(`other_${questionId}`);
      if (otherInput && selectedValue.includes('ãã®ä»–')) {
        const checkbox = event.target;
        if (checkbox.checked) {
          otherInput.style.display = 'block';
          otherInput.focus();
        } else {
          // ä»–ã®ã€Œãã®ä»–ã€ãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿éè¡¨ç¤º
          const checkboxes = document.getElementsByName(`q_${questionId}`);
          const hasOtherChecked = Array.from(checkboxes).some(cb =>
            cb.checked && cb.value.includes('ãã®ä»–')
          );
          if (!hasOtherChecked) {
            otherInput.style.display = 'none';
            otherInput.value = '';
          }
        }
      }
    }

    // ã€Œãã®ä»–ã€å…¥åŠ›æ¬„ã®å¤‰æ›´å‡¦ç†
    function handleOtherInput(questionId) {
      const otherInput = document.getElementById(`other_${questionId}`);
      const question = questionsData.find(q => q.id === questionId);

      if (otherInput && question) {
        const elements = document.getElementsByName(`q_${questionId}`);

        if (question.type === 'radio') {
          // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å ´åˆï¼šã€Œãã®ä»–ã€ã®valueã‚’æ›´æ–°
          elements.forEach(el => {
            if (el.value.includes('ãã®ä»–') && el.checked) {
              if (otherInput.value.trim()) {
                el.value = `ãã®ä»–:${otherInput.value.trim()}`;
              } else {
                el.value = 'ãã®ä»–';
              }
            }
          });
        } else if (question.type === 'checkbox') {
          // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å ´åˆï¼šã€Œãã®ä»–ã€ã®valueã‚’æ›´æ–°
          elements.forEach(el => {
            if (el.value.includes('ãã®ä»–') && el.checked) {
              if (otherInput.value.trim()) {
                el.value = `ãã®ä»–:${otherInput.value.trim()}`;
              } else {
                el.value = 'ãã®ä»–';
              }
            }
          });
        }
      }
    }
    // ç¢ºèªç”»é¢ã‚’è¡¨ç¤º
    function showConfirm() {
      // å¿…é ˆé …ç›®ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const requiredQuestions = questionsData.filter(q => q.required);
      const missingAnswers = [];

      requiredQuestions.forEach(question => {
        const elements = document.getElementsByName(`q_${question.id}`);
        let hasAnswer = false;

        if (question.type === 'radio') {
          hasAnswer = Array.from(elements).some(el => el.checked);
        } else if (question.type === 'checkbox') {
          hasAnswer = Array.from(elements).some(el => el.checked);
        } else if (question.type === 'text') {
          hasAnswer = elements[0] && elements[0].value.trim() !== '';
        }

        if (!hasAnswer) {
          missingAnswers.push(question.title);
        }
      });

      if (missingAnswers.length > 0) {
        showError('survey-error', `æ¬¡ã®å¿…é ˆé …ç›®ã«å›ç­”ã—ã¦ãã ã•ã„ï¼š\n${missingAnswers.join('\n')}`);
        return;
      }

      // å›ç­”ã‚’åé›†
      collectAnswers();

      // ç¢ºèªç”»é¢ã«è¡¨ç¤º
      document.getElementById('confirm-name').textContent = document.getElementById('name').value;
      document.getElementById('confirm-email').textContent = document.getElementById('email').value;
      document.getElementById('confirm-organization').textContent = document.getElementById('organization').value;
      document.getElementById('confirm-gender').textContent =
        document.querySelector('input[name="gender"]:checked')?.value || '';

      renderConfirmAnswers();

      hideAllSections();
      document.getElementById('confirm-section').classList.remove('hidden');
      clearError('survey-error');
    }

    // å›ç­”ã‚’åé›†
    function collectAnswers() {
      currentAnswers = {};

      questionsData.forEach(question => {
        const elements = document.getElementsByName(`q_${question.id}`);

        if (question.type === 'radio') {
          const checked = Array.from(elements).find(el => el.checked);
          if (checked) {
            let value = checked.value;

            // ã€Œãã®ä»–ã€ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è‡ªç”±è¨˜è¿°ã®å†…å®¹ã‚’å–å¾—
            if (value.includes('ãã®ä»–')) {
              const otherInput = document.getElementById(`other_${question.id}`);
              if (otherInput && otherInput.value.trim()) {
                value = `ãã®ä»–:${otherInput.value.trim()}`;
              }
            }

            currentAnswers[question.id] = value;
          }
        } else if (question.type === 'checkbox') {
          const checkedValues = Array.from(elements)
            .filter(el => el.checked)
            .map(el => {
              let value = el.value;

              // ã€Œãã®ä»–ã€ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è‡ªç”±è¨˜è¿°ã®å†…å®¹ã‚’å–å¾—
              if (value.includes('ãã®ä»–')) {
                const otherInput = document.getElementById(`other_${question.id}`);
                if (otherInput && otherInput.value.trim()) {
                  value = `ãã®ä»–:${otherInput.value.trim()}`;
                }
              }

              return value;
            });
          if (checkedValues.length > 0) {
            currentAnswers[question.id] = checkedValues.join(', ');
          }
        } else if (question.type === 'text') {
          if (elements[0] && elements[0].value.trim()) {
            currentAnswers[question.id] = elements[0].value.trim();
          }
        }
      });
    }

    // ç¢ºèªç”»é¢ã«å›ç­”ã‚’è¡¨ç¤º
    function renderConfirmAnswers() {
      const container = document.getElementById('confirm-answers');
      container.innerHTML = '';

      const table = document.createElement('table');
      table.className = 'confirm-table';

      questionsData.forEach(question => {
        if (currentAnswers[question.id]) {
          const row = table.insertRow();
          const titleCell = row.insertCell(0);
          const answerCell = row.insertCell(1);

          titleCell.innerHTML = `<strong>${question.title}</strong>`;
          answerCell.textContent = currentAnswers[question.id];
        }
      });

      container.appendChild(table);
    }

    // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
    function submitAll() {
      // ä¼šå“¡ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const organization = document.getElementById('organization').value;
      const gender = document.querySelector('input[name="gender"]:checked')?.value || '';

      Promise.all([
        new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .updateMemberData(cachedMemberID, name, email, organization, gender);
        }),
        new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .submitAnswers(cachedMemberID, currentAnswers);
        })
      ])
        .then(results => {
          if (results.every(r => r.success)) {
            hideAllSections();
            document.getElementById('complete-section').classList.remove('hidden');
          } else {
            alert('é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
          }
        })
        .catch(error => {
          console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
          alert('é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        });
    }

    // éƒ¨åˆ†ä¿å­˜æ©Ÿèƒ½
    function savePartialAnswers() {
      // ç¾åœ¨ã®å›ç­”ã‚’åé›†
      collectAnswers();

      if (Object.keys(currentAnswers).length === 0) {
        showError('survey-error', 'ä¿å­˜ã™ã‚‹å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }

      google.script.run
        .withSuccessHandler(function (response) {
          if (response.success) {
            showSuccess('survey-success', 'å›ç­”ã‚’éƒ¨åˆ†ä¿å­˜ã—ã¾ã—ãŸã€‚å¾Œã§ç¶šãã‹ã‚‰å›ç­”ã§ãã¾ã™ã€‚');
            clearError('survey-error');
          } else {
            showError('survey-error', response.message || 'éƒ¨åˆ†ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        })
        .withFailureHandler(function (error) {
          showError('survey-error', 'éƒ¨åˆ†ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
          console.error(error);
        })
        .updatePartialAnswers(cachedMemberID, currentAnswers);
    }

    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    function showSuccess(elementId, message) {
      const successElement = document.getElementById(elementId);
      successElement.textContent = message;
      successElement.style.display = 'block';

      // 3ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
      setTimeout(() => {
        successElement.style.display = 'none';
      }, 3000);
    }

    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
    function backToMember() {
      hideAllSections();
      document.getElementById('member-section').classList.remove('hidden');
    }

    function backToSurvey() {
      hideAllSections();
      document.getElementById('survey-section').classList.remove('hidden');
    }

    function startOver() {
      hideAllSections();
      document.getElementById('login-section').classList.remove('hidden');
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('memberID').value = '';
      document.getElementById('password').value = '';
      cachedMemberID = '';
      questionsData = [];
      currentAnswers = {};
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    function hideAllSections() {
      document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
      });
    }

    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.style.display = 'block';
    }

    function clearError(elementId) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = '';
      errorElement.style.display = 'none';
    }
  </script>
</body>

</html>
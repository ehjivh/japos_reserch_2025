<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>日本公開天文台協会 2025年公開天文台調査</title>
  <style>
    body {
      font-family: 'Hiragino Sans', 'ヒラギノ角ゴシック', 'Yu Gothic', 'メイリオ', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      line-height: 1.6;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1,
    h2,
    h3 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 5px;
    }

    .section {
      margin-bottom: 30px;
    }

    .hidden {
      display: none;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      color: #555;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    textarea,
    select {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus,
    textarea:focus {
      border-color: #4CAF50;
      outline: none;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .radio-group,
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 10px;
    }

    .radio-group label,
    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: normal;
      margin-bottom: 0;
      cursor: pointer;
      padding: 5px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
      transition: background-color 0.3s;
    }

    .radio-group label:hover,
    .checkbox-group label:hover {
      background-color: #e9f5e9;
    }

    .radio-group input[type="radio"],
    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    button {
      background-color: #4CAF50;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
      margin-bottom: 10px;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #45a049;
    }

    button.secondary {
      background-color: #757575;
    }

    button.secondary:hover {
      background-color: #616161;
    }

    .error {
      color: #f44336;
      font-size: 14px;
      margin-top: 5px;
    }

    .success {
      color: #4CAF50;
      font-size: 16px;
      text-align: center;
      padding: 20px;
      background-color: #e8f5e8;
      border-radius: 4px;
    }

    .user-info {
      background-color: #e3f2fd;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .question {
      background-color: #fafafa;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      border-left: 4px solid #4CAF50;
    }

    .question-title {
      font-weight: bold;
      margin-bottom: 10px;
    }

    .question-description {
      color: #666;
      font-size: 14px;
      margin-bottom: 15px;
      line-height: 1.5;
      background-color: #f0f7ff;
      padding: 10px;
      border-radius: 4px;
      border-left: 3px solid #2196F3;
    }

    .other-input {
      width: 100%;
      margin-top: 10px;
      padding: 8px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
      display: none;
    }

    .other-input:focus {
      border-color: #4CAF50;
      outline: none;
    }

    .required {
      color: #f44336;
      font-size: 12px;
    }

    .confirm-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .confirm-table th,
    .confirm-table td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: left;
    }

    .confirm-table th {
      background-color: #f5f5f5;
      font-weight: bold;
      width: 30%;
    }

    @media (max-width: 600px) {
      .container {
        padding: 15px;
      }

      .radio-group,
      .checkbox-group {
        flex-direction: column;
      }

      button {
        width: 100%;
        margin-right: 0;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>日本公開天文台協会 2025年公開天文台調査</h1>

    <!-- ログイン画面 -->
    <div id="login-section" class="section">
      <h2>ログイン</h2>
      <div class="form-group">
        <label for="memberID">会員番号 <span class="required">*</span></label>
        <input type="text" id="memberID" required>
      </div>
      <div class="form-group">
        <label for="password">パスワード <span class="required">*</span></label>
        <input type="password" id="password" required>
      </div>
      <button onclick="checkCredentials()">ログイン</button>
      <div id="login-error" class="error"></div>
    </div>

    <!-- 会員情報編集画面 -->
    <div id="member-section" class="section hidden">
      <h2>回答者の情報</h2>
      <div class="user-info">
        <p><strong>ログイン中：</strong><span id="display-name"></span> さん</p>
      </div>

      <div class="form-group">
        <label for="name">氏名 <span class="required">*</span></label>
        <input type="text" id="name" required>
      </div>

      <div class="form-group">
        <label for="email">メールアドレス <span class="required">*</span></label>
        <input type="email" id="email" required>
      </div>

      <div class="form-group">
        <label for="organization">所属</label>
        <input type="text" id="organization">
      </div>

      <button onclick="proceedToSurvey()">アンケートに進む</button>
    </div>

    <!-- アンケート画面 -->
    <div id="survey-section" class="section hidden">
      <h2>アンケート</h2>
      <div id="questions-container"></div>
      <button onclick="showConfirm()">確認画面へ</button>
      <button onclick="savePartialAnswers()" class="secondary">部分保存</button>
      <button class="secondary" onclick="backToMember()">会員情報に戻る</button>
      <div id="survey-error" class="error"></div>
      <div id="survey-success" class="success" style="display: none;"></div>
    </div>

    <!-- 確認画面 -->
    <div id="confirm-section" class="section hidden">
      <h2>回答内容確認</h2>

      <h3>会員情報</h3>
      <table class="confirm-table">
        <tr>
          <th>氏名</th>
          <td id="confirm-name"></td>
        </tr>
        <tr>
          <th>メールアドレス</th>
          <td id="confirm-email"></td>
        </tr>
        <tr>
          <th>所属</th>
          <td id="confirm-organization"></td>
        </tr>
        <tr>
          <th>性別</th>
          <td id="confirm-gender"></td>
        </tr>
      </table>

      <h3>アンケート回答</h3>
      <div id="confirm-answers"></div>

      <div style="margin-top: 30px;">
        <button onclick="submitAll()">この内容で送信</button>
        <button class="secondary" onclick="backToSurvey()">修正する</button>
      </div>
    </div>

    <!-- 完了画面 -->
    <div id="complete-section" class="section hidden">
      <div class="success">
        <h2>送信完了</h2>
        <p>アンケートの回答が正常に送信されました。<br>ご協力ありがとうございました。</p>
        <button onclick="startOver()">新しく回答する</button>
      </div>
    </div>
  </div>

  <script>
    let cachedMemberID = "";
    let questionsData = [];
    let currentAnswers = {};

    // ログイン処理
    function checkCredentials() {
      const memberID = document.getElementById('memberID').value;
      const password = document.getElementById('password').value;

      if (!memberID || !password) {
        showError('login-error', '会員番号とパスワードを入力してください。');
        return;
      }

      cachedMemberID = memberID;

      google.script.run
        .withSuccessHandler(function (response) {
          if (response.success) {
            // 会員情報を表示
            document.getElementById('display-name').textContent = response.name;
            document.getElementById('name').value = response.name || '';
            document.getElementById('email').value = response.email || '';
            document.getElementById('organization').value = response.organization || '';

            // 性別の初期値を設定
            if (response.gender) {
              const radios = document.getElementsByName('gender');
              for (let radio of radios) {
                if (radio.value === response.gender) {
                  radio.checked = true;
                }
              }
            }

            // 画面切り替え
            hideAllSections();
            document.getElementById('member-section').classList.remove('hidden');
            clearError('login-error');
          } else {
            showError('login-error', response.message || '認証に失敗しました。');
          }
        })
        .withFailureHandler(function (error) {
          showError('login-error', 'システムエラーが発生しました。');
          console.error(error);
        })
        .getUserData(memberID, password);
    }

    // アンケート画面に進む
    function proceedToSurvey() {
      // 設問データを取得してアンケート画面を表示
      google.script.run
        .withSuccessHandler(function (response) {
          if (response.success) {
            questionsData = response.questions;
            renderQuestions();
            loadExistingAnswers();
            hideAllSections();
            document.getElementById('survey-section').classList.remove('hidden');
          } else {
            showError('survey-error', response.message || '設問データの取得に失敗しました。');
          }
        })
        .withFailureHandler(function (error) {
          showError('survey-error', 'システムエラーが発生しました。');
          console.error(error);
        })
        .getQuestionData();
    }

    // 既存の回答を読み込み
    function loadExistingAnswers() {
      google.script.run
        .withSuccessHandler(function (response) {
          if (response.success) {
            currentAnswers = response.answers;

            // 既存回答がある場合の通知表示
            if (response.hasExistingData) {
              showExistingDataNotification();
            }

            // フォームに既存の回答を反映
            Object.keys(currentAnswers).forEach(questionId => {
              setAnswerToForm(questionId, currentAnswers[questionId]);
            });
          }
        })
        .withFailureHandler(function (error) {
          console.error('既存回答の取得に失敗:', error);
        })
        .getExistingAnswers(cachedMemberID);
    }

    // 既存データがある場合の通知を表示
    function showExistingDataNotification() {
      const container = document.getElementById('questions-container');
      const notification = document.createElement('div');
      notification.className = 'existing-data-notification';
      notification.innerHTML = `
        <div style="background-color: #e3f2fd; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
          <strong>📋 既存の回答データが見つかりました</strong><br>
          前回の回答内容が自動的に読み込まれています。<br>
          必要に応じて修正してください。
        </div>
      `;
      container.insertBefore(notification, container.firstChild);
    }

    // 設問をレンダリング
    function renderQuestions() {
      const container = document.getElementById('questions-container');
      container.innerHTML = '';

      questionsData.forEach(question => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question';
        questionDiv.innerHTML = createQuestionHTML(question);
        container.appendChild(questionDiv);
      });

      // 既存回答がある場合は通知を先頭に追加
      if (Object.keys(currentAnswers).length > 0) {
        showExistingDataNotification();
      }
    }

    // 設問HTMLを生成
    function createQuestionHTML(question) {
      let html = `<div class="question-title">
          ${question.title}
          ${question.required ? '<span class="required">*</span>' : ''}
        </div>`;

      // 説明文がある場合は表示
      if (question.description && question.description.trim() !== '') {
        html += `<div class="question-description">${question.description}</div>`;
      }

      switch (question.type) {
        case 'radio':
          html += `<div class="radio-group">`;
          question.options.forEach(option => {
            html += `<label>
                <input type="radio" name="q_${question.id}" value="${option}" 
                       ${question.required ? 'required' : ''}
                       onchange="handleRadioChange('${question.id}', '${option}')">
                ${option}
              </label>`;
          });
          html += `</div>`;

          // 「その他」の自由記述欄を追加
          if (question.options.some(opt => opt.includes('その他'))) {
            html += `<input type="text" class="other-input" id="other_${question.id}" 
                     placeholder="その他の場合は具体的にご記入ください..." 
                     onchange="handleOtherInput('${question.id}')">`;
          }
          break;

        case 'checkbox':
          html += `<div class="checkbox-group">`;
          question.options.forEach(option => {
            html += `<label>
                <input type="checkbox" name="q_${question.id}" value="${option}"
                       onchange="handleCheckboxChange('${question.id}', '${option}')">
                ${option}
              </label>`;
          });
          html += `</div>`;

          // 「その他」の自由記述欄を追加
          if (question.options.some(opt => opt.includes('その他'))) {
            html += `<input type="text" class="other-input" id="other_${question.id}" 
                     placeholder="その他の場合は具体的にご記入ください..." 
                     onchange="handleOtherInput('${question.id}')">`;
          }
          break;

        case 'text':
          html += `<textarea name="q_${question.id}" placeholder="こちらにご記入ください..." 
                     ${question.required ? 'required' : ''}></textarea>`;
          break;
      }

      return html;
    }

    // フォームに既存の回答を設定
    function setAnswerToForm(questionId, answer) {
      const question = questionsData.find(q => q.id === questionId);
      if (!question) return;

      const elements = document.getElementsByName(`q_${questionId}`);

      if (question.type === 'radio') {
        elements.forEach(el => {
          if (el.value === answer) {
            el.checked = true;
            // 「その他」の場合は入力欄を表示
            if (answer.includes('その他') && answer !== 'その他') {
              const otherInput = document.getElementById(`other_${questionId}`);
              if (otherInput) {
                otherInput.style.display = 'block';
                otherInput.value = answer.replace('その他:', '').trim();
              }
            }
          }
        });
      } else if (question.type === 'checkbox') {
        const answers = answer.split(',').map(a => a.trim());
        elements.forEach(el => {
          if (answers.some(ans => ans === el.value || (ans.includes('その他') && el.value.includes('その他')))) {
            el.checked = true;
          }
        });

        // 「その他」の回答がある場合は入力欄を表示
        const otherAnswer = answers.find(ans => ans.includes('その他') && ans !== 'その他');
        if (otherAnswer) {
          const otherInput = document.getElementById(`other_${questionId}`);
          if (otherInput) {
            otherInput.style.display = 'block';
            otherInput.value = otherAnswer.replace('その他:', '').trim();
          }
        }
      } else if (question.type === 'text') {
        if (elements[0]) {
          elements[0].value = answer;
        }
      }
    }

    // ラジオボタンの変更処理
    function handleRadioChange(questionId, selectedValue) {
      const otherInput = document.getElementById(`other_${questionId}`);
      if (otherInput) {
        if (selectedValue.includes('その他')) {
          otherInput.style.display = 'block';
          otherInput.focus();
        } else {
          otherInput.style.display = 'none';
          otherInput.value = '';
        }
      }
    }

    // チェックボックスの変更処理
    function handleCheckboxChange(questionId, selectedValue) {
      const otherInput = document.getElementById(`other_${questionId}`);
      if (otherInput && selectedValue.includes('その他')) {
        const checkbox = event.target;
        if (checkbox.checked) {
          otherInput.style.display = 'block';
          otherInput.focus();
        } else {
          // 他の「その他」がチェックされていない場合のみ非表示
          const checkboxes = document.getElementsByName(`q_${questionId}`);
          const hasOtherChecked = Array.from(checkboxes).some(cb =>
            cb.checked && cb.value.includes('その他')
          );
          if (!hasOtherChecked) {
            otherInput.style.display = 'none';
            otherInput.value = '';
          }
        }
      }
    }

    // 「その他」入力欄の変更処理
    function handleOtherInput(questionId) {
      const otherInput = document.getElementById(`other_${questionId}`);
      const question = questionsData.find(q => q.id === questionId);

      if (otherInput && question) {
        const elements = document.getElementsByName(`q_${questionId}`);

        if (question.type === 'radio') {
          // ラジオボタンの場合：「その他」のvalueを更新
          elements.forEach(el => {
            if (el.value.includes('その他') && el.checked) {
              if (otherInput.value.trim()) {
                el.value = `その他:${otherInput.value.trim()}`;
              } else {
                el.value = 'その他';
              }
            }
          });
        } else if (question.type === 'checkbox') {
          // チェックボックスの場合：「その他」のvalueを更新
          elements.forEach(el => {
            if (el.value.includes('その他') && el.checked) {
              if (otherInput.value.trim()) {
                el.value = `その他:${otherInput.value.trim()}`;
              } else {
                el.value = 'その他';
              }
            }
          });
        }
      }
    }
    // 確認画面を表示
    function showConfirm() {
      // 必須項目のバリデーション
      const requiredQuestions = questionsData.filter(q => q.required);
      const missingAnswers = [];

      requiredQuestions.forEach(question => {
        const elements = document.getElementsByName(`q_${question.id}`);
        let hasAnswer = false;

        if (question.type === 'radio') {
          hasAnswer = Array.from(elements).some(el => el.checked);
        } else if (question.type === 'checkbox') {
          hasAnswer = Array.from(elements).some(el => el.checked);
        } else if (question.type === 'text') {
          hasAnswer = elements[0] && elements[0].value.trim() !== '';
        }

        if (!hasAnswer) {
          missingAnswers.push(question.title);
        }
      });

      if (missingAnswers.length > 0) {
        showError('survey-error', `次の必須項目に回答してください：\n${missingAnswers.join('\n')}`);
        return;
      }

      // 回答を収集
      collectAnswers();

      // 確認画面に表示
      document.getElementById('confirm-name').textContent = document.getElementById('name').value;
      document.getElementById('confirm-email').textContent = document.getElementById('email').value;
      document.getElementById('confirm-organization').textContent = document.getElementById('organization').value;
      document.getElementById('confirm-gender').textContent =
        document.querySelector('input[name="gender"]:checked')?.value || '';

      renderConfirmAnswers();

      hideAllSections();
      document.getElementById('confirm-section').classList.remove('hidden');
      clearError('survey-error');
    }

    // 回答を収集
    function collectAnswers() {
      currentAnswers = {};

      questionsData.forEach(question => {
        const elements = document.getElementsByName(`q_${question.id}`);

        if (question.type === 'radio') {
          const checked = Array.from(elements).find(el => el.checked);
          if (checked) {
            let value = checked.value;

            // 「その他」が選択されている場合は自由記述の内容を取得
            if (value.includes('その他')) {
              const otherInput = document.getElementById(`other_${question.id}`);
              if (otherInput && otherInput.value.trim()) {
                value = `その他:${otherInput.value.trim()}`;
              }
            }

            currentAnswers[question.id] = value;
          }
        } else if (question.type === 'checkbox') {
          const checkedValues = Array.from(elements)
            .filter(el => el.checked)
            .map(el => {
              let value = el.value;

              // 「その他」が選択されている場合は自由記述の内容を取得
              if (value.includes('その他')) {
                const otherInput = document.getElementById(`other_${question.id}`);
                if (otherInput && otherInput.value.trim()) {
                  value = `その他:${otherInput.value.trim()}`;
                }
              }

              return value;
            });
          if (checkedValues.length > 0) {
            currentAnswers[question.id] = checkedValues.join(', ');
          }
        } else if (question.type === 'text') {
          if (elements[0] && elements[0].value.trim()) {
            currentAnswers[question.id] = elements[0].value.trim();
          }
        }
      });
    }

    // 確認画面に回答を表示
    function renderConfirmAnswers() {
      const container = document.getElementById('confirm-answers');
      container.innerHTML = '';

      const table = document.createElement('table');
      table.className = 'confirm-table';

      questionsData.forEach(question => {
        if (currentAnswers[question.id]) {
          const row = table.insertRow();
          const titleCell = row.insertCell(0);
          const answerCell = row.insertCell(1);

          titleCell.innerHTML = `<strong>${question.title}</strong>`;
          answerCell.textContent = currentAnswers[question.id];
        }
      });

      container.appendChild(table);
    }

    // 全データを送信
    function submitAll() {
      // 会員データを更新
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const organization = document.getElementById('organization').value;
      const gender = document.querySelector('input[name="gender"]:checked')?.value || '';

      Promise.all([
        new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .updateMemberData(cachedMemberID, name, email, organization, gender);
        }),
        new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .submitAnswers(cachedMemberID, currentAnswers);
        })
      ])
        .then(results => {
          if (results.every(r => r.success)) {
            hideAllSections();
            document.getElementById('complete-section').classList.remove('hidden');
          } else {
            alert('送信中にエラーが発生しました。もう一度お試しください。');
          }
        })
        .catch(error => {
          console.error('送信エラー:', error);
          alert('送信中にエラーが発生しました。もう一度お試しください。');
        });
    }

    // 部分保存機能
    function savePartialAnswers() {
      // 現在の回答を収集
      collectAnswers();

      if (Object.keys(currentAnswers).length === 0) {
        showError('survey-error', '保存する回答がありません。');
        return;
      }

      google.script.run
        .withSuccessHandler(function (response) {
          if (response.success) {
            showSuccess('survey-success', '回答を部分保存しました。後で続きから回答できます。');
            clearError('survey-error');
          } else {
            showError('survey-error', response.message || '部分保存に失敗しました。');
          }
        })
        .withFailureHandler(function (error) {
          showError('survey-error', '部分保存中にエラーが発生しました。');
          console.error(error);
        })
        .updatePartialAnswers(cachedMemberID, currentAnswers);
    }

    // 成功メッセージを表示
    function showSuccess(elementId, message) {
      const successElement = document.getElementById(elementId);
      successElement.textContent = message;
      successElement.style.display = 'block';

      // 3秒後に自動で非表示
      setTimeout(() => {
        successElement.style.display = 'none';
      }, 3000);
    }

    // ナビゲーション関数
    function backToMember() {
      hideAllSections();
      document.getElementById('member-section').classList.remove('hidden');
    }

    function backToSurvey() {
      hideAllSections();
      document.getElementById('survey-section').classList.remove('hidden');
    }

    function startOver() {
      hideAllSections();
      document.getElementById('login-section').classList.remove('hidden');
      // フォームをリセット
      document.getElementById('memberID').value = '';
      document.getElementById('password').value = '';
      cachedMemberID = '';
      questionsData = [];
      currentAnswers = {};
    }

    // ユーティリティ関数
    function hideAllSections() {
      document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
      });
    }

    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.style.display = 'block';
    }

    function clearError(elementId) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = '';
      errorElement.style.display = 'none';
    }
  </script>
</body>

</html>